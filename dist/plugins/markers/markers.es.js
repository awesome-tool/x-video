import e from"video.js";var r={markerStyle:{width:"7px","border-radius":"30%","background-color":"red",top:"0em"},markerTip:{display:!0,text:function(e){return e.text},time:function(e){return e.time}},breakOverlay:{display:!0,displayTime:3,text:function(e){return"Break overlay: "+e.overlayText},style:{width:"100%",height:"20%","background-color":"rgba(0,0,0,0.7)",color:"white","font-size":"17px"}},markers:[]},t=function(e){var r;try{r=e.getBoundingClientRect()}catch(e){r={top:0,bottom:0,left:0,width:0,height:0,right:0}}return r},i=function(){function i(t,i){var a=this;void 0===i&&(i={}),this.player_=t,this.options_=e.mergeOptions(r,i),this.markersMap_={},this.currentMarkerIndex_=-1,this.markerTip_=null,this.breakOverlay_=null,this.overlayIndex_=-1,this.markers=[],this.player_.on("loadedmetadata",(function(){a.initialize()}))}var a=i.prototype;return a.sortMarkers=function(){var e=this;this.markers.sort((function(r,t){return e.options_.markerTip.time(r)-e.options_.markerTip.time(t)}))},a.getPosition=function(e){return this.options_.markerTip.time(e)/this.player_.duration()*100},a.addMarkers=function(e){var r=this;e.forEach((function(e){var t;e.key=(t=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?r:3&r|8).toString(16)}))),r.player_.el().querySelector(".vjs-progress-holder").appendChild(r.createMarkerEl(e)),r.markersMap_[e.key]=e,r.markers.push(e)})),this.sortMarkers()},a.createMarkerEl=function(r){var t=this,i=e.dom.createEl("div",{},{"data-marker-key":r.key,"data-marker-time":this.options_.markerTip.time(r)});return this.setMarkerElStyle(r,i),i.addEventListener("click",(function(){var e=i.getAttribute("data-marker-key");t.player_.currentTime(t.options_.markerTip.time(t.markersMap_[e])),t.player_.trigger("marker-click",r)})),this.options_.markerTip.display&&this.registerMarkerTipHandler(i),i},a.updateMarkers=function(e){var r=this;this.markers.forEach((function(t){var i=r.player_.el().querySelector(".vjs-marker[data-marker-key='"+t.key+"']"),a=r.options_.markerTip.time(t);(e||i.getAttribute("data-marker-time")!==a)&&(setMarkerElStyle(t,i),i.setAttribute("data-marker-time",a))})),this.sortMarkers()},a.removeMarkers=function(e){var r=this;this.breakOverlay_&&(this.overlayIndex_=-1,this.breakOverlay_.style.visibility="hidden"),this.currentMarkerIndex_=-1;var t=[];e.forEach((function(e){var i=r.markers[e];if(i){delete r.markersMap_[i.key],t.push(e);var a=r.player_.el().querySelector(".vjs-marker[data-marker-key='"+i.key+"']");a&&a.parentNode.removeChild(a)}})),t.reverse(),t.forEach((function(e){r.markers.splice(e,1)})),this.sortMarkers()},a.setMarkerElStyle=function(e,r){var i=this;r.className="vjs-marker "+(e.class||""),Object.keys(this.options_.markerStyle).forEach((function(e){r.style[e]=i.options_.markerStyle[e]}));var a=e.time/this.player_.duration();if((a<0||a>1)&&(r.style.display="none"),r.style.left=this.getPosition(e)+"%",e.duration)r.style.width=e.duration/this.player_.duration()*100+"%",r.style.marginLeft="0px";else{var s=t(r);r.style.marginLeft=s.width/2+"px"}},a.registerMarkerTipHandler=function(e){var r=this;e.addEventListener("mouseover",(function(){var i=r.markersMap_[e.getAttribute("data-marker-key")];if(r.markerTip_){r.options_.markerTip.html?r.markerTip_.querySelector(".vjs-tip-inner").innerHTML=r.options_.markerTip.html(i):r.markerTip_.querySelector(".vjs-tip-inner").innerText=r.options_.markerTip.text(i),r.markerTip_.style.left=r.getPosition(i)+"%";var a=t(r.markerTip_),s=t(e);r.markerTip_.style.marginLeft=-parseFloat(a.width/2)+parseFloat(s.width/4)+"px",r.markerTip_.style.top=parseFloat(a.height)+parseFloat(s.height)-50+"px",r.markerTip_.style.visibility="visible"}})),e.addEventListener("mouseout",(function(){r.markerTip_&&(r.markerTip_.style.visibility="hidden")}))},a.initializeMarkerTip=function(){this.markerTip_=e.dom.createEl("div",{className:"vjs-tip",innerHTML:"<div class='vjs-tip-inner'></div>"}),this.player_.el().querySelector(".vjs-progress-holder").appendChild(this.markerTip_)},a.updateBreakOverlay=function(){if(this.options_.breakOverlay.display&&!(this.currentMarkerIndex_<0)){var e=this.player_.currentTime(),r=this.markers[this.currentMarkerIndex_],t=this.options_.markerTip.time(r),i=r.overlayText;e>=t&&e<=t+this.options_.breakOverlay.displayTime&&i?(this.overlayIndex_!==this.currentMarkerIndex_&&(this.overlayIndex_=this.currentMarkerIndex_,this.breakOverlay_&&(this.breakOverlay_.querySelector(".vjs-break-overlay-text").innerHTML=this.options_.breakOverlay.text(r))),this.breakOverlay_&&(this.breakOverlay_.style.visibility="visible")):(this.overlayIndex_=-1,this.breakOverlay_&&(this.breakOverlay_.style.visibility="hidden"))}},a.initializeOverlay=function(){var r=this;this.breakOverlay_=e.dom.createEl("div",{className:"vjs-break-overlay",innerHTML:"<div class='vjs-break-overlay-text'></div>"}),Object.keys(this.options_.breakOverlay.style).forEach((function(e){r.breakOverlay_&&(r.breakOverlay_.style[e]=r.options_.breakOverlay.style[e])})),this.player_.el().appendChild(this.breakOverlay_),this.overlayIndex_=-1},a.onUpdateMarker=function(){var e=this;if(this.markers.length){var r=function(r){return r<e.markers.length-1?e.options_.markerTip.time(e.markers[r+1]):e.player_.duration()},t=this.player_.currentTime(),i=-1;if(-1!==this.currentMarkerIndex_){var a=r(this.currentMarkerIndex_);if(t>=this.options_.markerTip.time(this.markers[this.currentMarkerIndex_])&&t<a)return;if(this.currentMarkerIndex_===this.markers.length-1&&t===this.player_.duration())return}if(t<this.options_.markerTip.time(this.markers[0]))i=-1;else for(var s=0;s<this.markers.length;s++){var n=r(s);if(t>=this.options_.markerTip.time(this.markers[s])&&t<n){i=s;break}}i!==this.currentMarkerIndex_&&(-1!==i&&this.player_.trigger("marker-reached",{index:i,marker:this.markers[i]}),this.currentMarkerIndex_=i)}},a.onTimeUpdate=function(){this.onUpdateMarker(),this.updateBreakOverlay()},a.initialize=function(){var e=this;this.options_.markerTip.display&&this.initializeMarkerTip(),this.removeAll(),this.addMarkers(this.options_.markers),this.options_.breakOverlay.display&&this.initializeOverlay(),this.onTimeUpdate(),this.player_.on("timeupdate",(function(){return e.onTimeUpdate()})),this.player_.off("loadedmetadata")},a.getMarkers=function(){return this.markers},a.next=function(){for(var e=this.player_.currentTime(),r=0;r<this.markers.length;r++){var t=this.options_.markerTip.time(this.markers[r]);if(t>e){this.player_.currentTime(t);break}}},a.prev=function(){for(var e=this.player_.currentTime(),r=this.markers.length-1;r>=0;r--){var t=this.options_.markerTip.time(this.markers[r]);if(t+.5<e)return void this.player_.currentTime(t)}},a.add=function(e){this.addMarkers(e)},a.remove=function(e){this.removeMarkers(e)},a.removeAll=function(){for(var e=[],r=0;r<this.markers.length;r++)e.push(r);this.removeMarkers(e)},a.updateTime=function(e){this.updateMarkers(e)},a.reset=function(e){this.removeAll(),addMarkers(e)},a.destroy=function(){this.removeAll(),this.breakOverlay_&&this.breakOverlay_.remove(),this.markerTip_&&this.markerTip_.remove(),this.player_.off("timeupdate",this.updateBreakOverlay),this.player_.off("timeupdate",this.onTimeUpdate),delete this.player_.marker},i}();e.registerPlugin("setMarkers",(function(e){var r=this.player_;r.markers=new i(r,e)})),e.hook("setup",(function(e){var r=e.options_.markerOptions;e.setMarkers(r)}));
